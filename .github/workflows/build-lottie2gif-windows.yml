name: build-thorvg-windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1️⃣ Checkout 源码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup MSYS2 + 必要工具
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: |
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-giflib
            coreutils

      # 3️⃣ Configure Meson
      - name: Configure build
        shell: msys2 {0}
        run: |
          meson setup build \
            -Dtools=lottie2gif,svg2png \
            -Dsavers=gif \
            -Dloaders=lottie,png,jpg,webp \
            --buildtype=release

      # 4️⃣ Build all targets
      - name: Build (Ninja)
        shell: msys2 {0}
        run: |
          ninja -C build

      # 5️⃣ Debug: list build folder (optional)
      - name: List build folder
        shell: msys2 {0}
        run: |
          echo "Listing build directory:"
          ls -R build

      # 6️⃣ Collect all executables
      - name: Collect all executables
        shell: msys2 {0}
        run: |
          mkdir -p artifact/bin
          find build -maxdepth 3 -type f -name "*.exe" -exec cp {} artifact/bin/ \;

      # 7️⃣ Convert Lottie JSON to GIF
      - name: Convert Lottie JSON to GIF
        shell: msys2 {0}
        run: |
          mkdir -p artifact/gif
          for file in examples/resources/lottie/*.json; do
            echo "Processing $file"
            ./build/tools/lottie2gif/tvg-lottie2gif.exe "$file" -r 240x240 -f 24 -b 000000
            gif_file="${file%.json}.gif"
            if [ -f "$gif_file" ]; then
              cp "$gif_file" artifact/gif/
              echo "GIF generated: $gif_file"
            else
              echo "GIF not generated for $file"
            fi
          done

      # 8️⃣ Upload executables
      - name: Upload executables
        uses: actions/upload-artifact@v4
        with:
          name: thorvg-windows-bins
          path: artifact/bin/

      # 9️⃣ Upload GIFs
      - name: Upload GIFs
        uses: actions/upload-artifact@v4
        with:
          name: lottie-gifs
          path: artifact/gif/
