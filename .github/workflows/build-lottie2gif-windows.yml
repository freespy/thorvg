name: build-thorvg-windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1️⃣ Checkout 源码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup MSYS2 + 必要工具
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: |
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-giflib
            coreutils
      # 3️⃣ Configure Meson
      - name: Configure build
        shell: msys2 {0}
        run: |
          meson setup build \
            -Dtools=lottie2gif,svg2png \
            -Dsavers=gif \
            -Dloaders=lottie,png,jpg,webp \
            --buildtype=release
      # 4️⃣ Build all targets
      - name: Build (Ninja)
        shell: msys2 {0}
        run: |
          ninja -C build
      # 5️⃣ Debug: 列出 build 目录内容（可选）
      - name: List build folder
        shell: msys2 {0}
        run: |
          echo "Listing build directory:"
          ls -R build
      # 6️⃣ 收集所有 exe 文件
      - name: Collect all executables
        shell: msys2 {0}
        run: |
          mkdir -p artifact
          find build -maxdepth 3 -type f -name "*.exe" -exec cp {} artifact/ \;
      # 7️⃣ 上传 artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: thorvg-windows-bins
          path: artifact/
